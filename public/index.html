<!DOCTYPE html>
<html lang="en">
<head>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script lang="text/javascript" src="/socket.io/socket.io.js"></script>
    <script src="/simple-peer/simplepeer.min.js"></script>
</head>
<body>
    <div class="container">
        <p>
            Your peer id is: <span id="myId"></span>
        </p>
        <div class="row">
            <div class="col-4" id="peers">
                <h2>Peers Available</h2>
            </div>
            <div class="col-8">
                <form id="connect">
                    <div class="form-group">
                        <label>Send to: </label>
                        <input type="text" class="form-control" id="sendTo" />
                    </div>
                    <div class="form-group">
                        <label>Message: </label>
                        <input type="text" class="form-control" id="message" />
                    </div>
                    <hr />
                    <button class="btn btn-primary" type="button" id="send">
                        Send
                    </button>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <h2>Messages</h2>
                <div id="messages">

                </div>
            </div>
        </div>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js" integrity="sha512-XKa9Hemdy1Ui3KSGgJdgMyYlUg1gM+QhL6cnlyTe2qzMCYm4nAZ1PsVerQzTTXzonUR+dmswHqgJPuwCq1MaAg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        /**
* Socket.io socket
*/
        let socket;

        /**
         * The stream object used to send media
         */
        let localStream = null;
        /**
         * All peer connections
         */
        let peers = {}

        let myId;

        // redirect if not https
        if (location.href.substr(0, 5) !== 'https')
            location.href = 'https' + location.href.substr(4, location.href.length - 4)


        //////////// CONFIGURATION //////////////////

        /**
         * RTCPeerConnection configuration
         */
        const configuration = {
            "iceServers": [{
                "urls": "stun:stun.l.google.com:19302"
            }
                /*
                // set your own servers here if needed
                Custom turn/stun servere
                ,{
                           "urls": ["stun:myturnserver.com"],
                           credential: '12345',
                           username: 'abcd'                },

                       {
                           "urls": ['turn:myturnserver.com'],
                           credential: '12345',
                           username: 'abcd'
                       }*/
            ]
        }



        /**
         * initialize the socket connections
         */
        function init() {
            socket = io("/")
            socket.on("connect", () => {
                console.log(socket.id, socket.io.engine.id, socket.json.id)
                myId = socket.id;
                $("#myId").text(myId);
            });

            socket.on('initReceive', socket_id => {
                console.log(socket_id, "init rcvd");
                addPeer(socket_id, false);
                socket.emit('initSend', socket_id)
            })

            socket.on('initSend', socket_id => {
                console.log(socket_id, "init sent");
                addPeer(socket_id, true)
            })

            socket.on('removePeer', socket_id => {
                console.log(socket_id, "peer removed");
                removePeer(socket_id)
            })


            socket.on('signal', data => {
                console.log(data, "got signal");
                $(".disconnected." + data.socket_id).text(data.socket_id + ": WebRtc Successful").removeClass("disconnected").addClass("connected");

                peers[data.socket_id].signal(data.signal)
            })


        }

        /**
         * Remove a peer with given socket_id.
         * Removes the video element and deletes the connection
         * @@param {String} socket_id
         */
        function removePeer(socket_id) {
            if (peers[socket_id]) peers[socket_id].destroy()
            delete peers[socket_id]
            $("." + socket_id).remove();
        }

        /**
         * Creates a new peer connection and sets the event listeners
         * @@param {String} socket_id
         *                 ID of the peer
         * @@param {Boolean} am_initiator
         *                  Set to true if the peer initiates the connection process.
         *                  Set to false if the peer receives the connection.
         */
        function addPeer(socket_id, am_initiator) {
            console.log("Adding peers ========>", socket_id, " ===>", am_initiator)
            peers[socket_id] = new SimplePeer({
                initiator: am_initiator,
                config: configuration
            })
            $("#peers").append($("<a>", { text: socket_id + ": No Webrtc", class: socket_id + " peerLink disconnected", href: "#", "data-socket_Id": socket_id }));
            peers[socket_id].on('signal', data => {
                console.log("Adding peers ========>", socket_id, " ===>", am_initiator)
                socket.emit('signal', {
                    signal: data,
                    socket_id: socket_id
                })
            })

            peers[socket_id].on('error', err => {
                console.log(err);
            })
            peers[socket_id].on('data', function (chunk) {
                var textChunk = chunk.toString('utf8');
                $("#messages").prepend($("<p>", { text: socket_id + " says: " + textChunk }))
                console.log(textChunk);
            });

        }

       
    </script>
    <script>
        $(function () {
            init();
            $("#send").on("click", function (ev) {
                ev.preventDefault();
                const socket_id = $("#sendTo").val();
                const message = $("#message").val();
                if (peers[socket_id] && message.length) {
                    peers[socket_id].send(message)
                    $("#message").val("");
                    $("#messages").prepend($("<p>", { text:"you said: " + message + " to " + socket_id }))
                }

            })
            $("body").on("click", ".peerLink.connected", function (ev) {
                ev.preventDefault();
                $("#sendTo").val($(this).attr("data-socket_Id"));
            })
        })
    </script>
</body>
</html>
